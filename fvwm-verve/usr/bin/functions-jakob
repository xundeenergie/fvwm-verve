#!/bin/sh

# Dieses Skript stellt div. Funktionen für meine Skripte zur Verfügung.
# Dieses Skript wird in anderen Skripten gesourced
# Bei Fragen: jakobus.schuerz@gmail.com

# sendet an alle graphisch angemeldeten User eine Nachricht an den notify-daemon

dbusnotifying () {

case $1 in
	-i) shift; export ICON="$1"; shift;;
esac

export message=$@;
who|awk '$NF ~ /:/{print $1}'|uniq|while read user
do
	pids=`pgrep -u $user`
	for pid in $pids; do
		# find DBUS session bus for this session
		grep -z DBUS_SESSION_BUS_ADDRESS \
	 	/proc/$pid/environ 2>/dev/null | sed -e 's/DBUS_SESSION_BUS_ADDRESS=//'
		echo
	done|sort -u|uniq|sed -e '/^$/d'|while read DBUS_SESSION_BUS_ADDRESS
	do	# use it
		export DBUS_SESSION_BUS_ADDRESS="$DBUS_SESSION_BUS_ADDRESS"
		[ -n $DBUS_SESSION_BUS_ADDRESS ] || continue
		if [ `echo $UID` -gt 0 ];
		then
			/usr/bin/notify-send -t 2000 -i "$ICON" "`basename "/"$0`" "$message"
		else
			su $user -c "notify-send -t 2000 -i "$ICON" '`basename $0`' '$message' 2>/dev/null" 2>/dev/null
		fi
		test $? -eq 0  && break
		#[ -z $DBUS_SESSION_BUS_ADDRESS ] || break
		unset DBUS_SESSION_BUS_ADDRESS
	done
done
}
